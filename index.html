<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Gaigle - AI-Powered Search</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="language-switcher" id="language-switcher">
        <!-- Will be filled by JavaScript -->
    </div>
    
    <div class="header">
        <a href="https://gaigle.ru/" id="website-root">
            <img src="assets/home.svg" width="16">
        </a>
        <a href="https://gaigle.ru/about" id="about-link">
            <img src="assets/about.svg" width="22">
        </a>
        <a href="#" id="settings-link">
            <img src="assets/settings.svg" width="20">
        </a>
    </div>
    
    <div class="main" id="main-content">
        <div class="logo" id="logo">Gaigle</div>
        
        <div class="search-container">
            <input type="text" class="search-box" id="search-input" placeholder="Search with Gaigle..." autocomplete="off" autofocus>
            <button class="search-button" id="search-icon-button" aria-label="Search">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
        </div>
        
        <div class="error-container" id="error-container"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loading-text">Searching with AI...</p>
        </div>
        
        <div class="results-container" id="results-container"></div>
        
        <div class="load-more" id="load-more-container" style="display: none;">
            <button class="load-more-button" id="load-more-button">More</button>
        </div>
    </div>
    
    <div class="footer" id="disclaimer">
        <p>This website is not affiliated with Google Corporation, and is not produced by it. All answers are made by AI and might not be 100% correct.</p>
    </div>
    
    <script>
        // Translations and configurations
        const translations = {
            en: {
                pageTitle: "Gaigle - AI-Powered Search",
                searchPlaceholder: "Search with Gaigle...",
                loadingText: "Searching with AI...",
                quickAnswer: "Quick Answer",
                noResults: "No results found. Try a different query.",
                errorMessage: "An unknown error occurred while searching. Please try again.",
                networkError: "Network error. Please check your internet connection.",
                apiError: "API server error. Please try again later.",
                apiTimeout: "The server is taking too long to respond",
                invalidRequest: "Invalid search query",
                serverError: "Server is currently unavailable",
                rateLimitExceeded: "Too many requests. Please wait before trying again.",
                switchToRussian: "Русский",
                switchToEnglish: "English",
                loadMore: "More",
                makeLonger: "Make longer",
                customPrompt: "Ask a follow-up question...",
                rateLimitWarning: "Too many requests! Please wait 15 seconds before searching again.",
                rateLimitSlowdown: "Too many requests! You can now make 1 request every 3 seconds.",
                disclaimer: "This site is not affiliated with or produced by Google Corporation. All answers are generated by AI and may not be 100% accurate."
            },
            ru: {
                pageTitle: "Gaigle - Поиск с ИИ",
                searchPlaceholder: "Поиск с помощью Gaigle...",
                loadingText: "Ищем с помощью ИИ...",
                quickAnswer: "Быстрый ответ",
                noResults: "Ничего не найдено. Попробуйте другой запрос.",
                errorMessage: "Произошла ошибка при поиске. Пожалуйста, попробуйте ещё раз.",
                networkError: "Ошибка сети. Пожалуйста, проверьте интернет-соединение.",
                apiError: "Ошибка сервера API. Пожалуйста, попробуйте позже.",
                apiTimeout: "Сервер слишком долго отвечает",
                invalidRequest: "Некорректный поисковый запрос",
                serverError: "Сервер временно недоступен",
                rateLimitExceeded: "Слишком много запросов. Пожалуйста, подождите перед повторной попыткой.",
                switchToRussian: "Русский",
                switchToEnglish: "English",
                loadMore: "Ещё",
                makeLonger: "Длиннее",
                customPrompt: "Уточняющий вопрос...",
                rateLimitWarning: "Слишком много запросов! Пожалуйста, подождите 15 секунд перед новым поиском.",
                rateLimitSlowdown: "Слишком много запросов! Теперь вы можете делать 1 запрос каждые 3 секунды.",
                disclaimer: "Данный сайт никак не связан с корпорацией Google, и не производится ей. Все ответы делаются нейросетью и не могут быть верны на 100%."
            }
        };

        // Countries where Russian should be default
        const russianSpeakingCountries = ['RU', 'BY', 'UA', 'KZ'];

        // Rate limiting configuration
        const RATE_LIMIT_CONFIG = {
            maxRequests: 5,
            timeWindow: 10, // seconds
            slowdownAfter: 10,
            slowdownDelay: 3, // seconds between requests
            banAfter: 15,
            banDuration: 15 // seconds
        };

        // API configuration for OnlySq API 2.0 with Searchgpt model
        const API_CONFIG = {
            baseUrl: "https://api.onlysq.ru/ai/v2",
            apiKey: "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", 
            model: "gpt-4o-mini-search-preview-2025-03-11",
            timeout: 10000, // 10 seconds
            retries: 2
        };

        // Global state
        let appState = {
            requestCount: 0,
            lastRequestTime: 0,
            rateLimitActive: false,
            rateLimitSlowdown: false,
            currentQuery: '',
            currentFastAnswer: '',
            activeRequests: 0,
            requestHistory: []
        };

        // Cookie functions
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Language functions
        function initLanguage() {
            const langCookie = getCookie('lang');
            
            if (langCookie && (langCookie === 'en' || langCookie === 'ru')) {
                setLanguage(langCookie);
            } else {
                detectLanguageByIP();
            }
        }

        function detectLanguageByIP() {
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    const countryCode = data.country;
                    const defaultLang = russianSpeakingCountries.includes(countryCode) ? 'ru' : 'en';
                    setLanguage(defaultLang);
                    setCookie('lang', defaultLang, 3);
                })
                .catch(() => {
                    setLanguage('en');
                    setCookie('lang', 'en', 3);
                });
        }

        function setLanguage(lang) {
            if (!translations[lang]) lang = 'en';
            
            // Update UI elements
            const elementsToUpdate = {
                'page-title': translations[lang].pageTitle,
                'search-input': translations[lang].searchPlaceholder,
                'loading-text': translations[lang].loadingText,
                'load-more-button': translations[lang].loadMore,
                'disclaimer': translations[lang].disclaimer
            };

            for (const [id, text] of Object.entries(elementsToUpdate)) {
                const element = document.getElementById(id);
                if (element) {
                    if (id === 'search-input') {
                        element.placeholder = text;
                    } else {
                        element.textContent = text;
                    }
                }
            }

            // Update language switcher
            const languageSwitcher = document.getElementById('language-switcher');
            if (languageSwitcher) {
                languageSwitcher.innerHTML = lang === 'en' 
                    ? `<button onclick="switchLanguage('ru')">${translations.en.switchToRussian}</button>`
                    : `<button onclick="switchLanguage('en')">${translations.ru.switchToEnglish}</button>`;
            }
        }

        // Markdown formatting functions
        function formatTextWithMarkdown(text) {
            if (!text) return text;
            
            // Process headings
            text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            
            // Process bold and italic
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/\_\_(.*?)\_\_/g, '<strong>$1</strong>');
            text = text.replace(/\_(.*?)\_/g, '<em>$1</em>');
            
            // Process line breaks
            text = text.replace(/\n/g, '<br>');
            
            // Process links
            text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            return text;
        }

        // Safe HTML rendering
        function safeFormatText(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return formatTextWithMarkdown(div.innerHTML);
        }

        // Error handling
        function handleApiError(error) {
            console.error('API Error:', error);
            const lang = getCookie('lang') || 'en';
            
            if (error.name === 'AbortError') {
                return translations[lang].apiTimeout;
            } else if (error.message.includes('NetworkError')) {
                return translations[lang].networkError;
            } else if (error.message.includes('400')) {
                return translations[lang].invalidRequest;
            } else if (error.message.includes('50')) {
                return translations[lang].serverError;
            } else if (error.message.includes('rate limit')) {
                return translations[lang].rateLimitExceeded;
            }
            
            return translations[lang].errorMessage;
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            if (errorContainer) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
            }
        }

        function hideError() {
            const errorContainer = document.getElementById('error-container');
            if (errorContainer) {
                errorContainer.style.display = 'none';
            }
        }

        // Global function to switch language
        function switchLanguage(lang) {
            if (translations[lang]) {
                setCookie('lang', lang, 3);
                window.location.reload();
            }
        }

        // Main application logic
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize language
            initLanguage();
            
            // DOM elements
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-icon-button');
            const resultsContainer = document.getElementById('results-container');
            const loadingElement = document.getElementById('loading');
            const loadMoreButton = document.getElementById('load-more-button');
            const loadMoreContainer = document.getElementById('load-more-container');
            
            // Event listeners
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            loadMoreButton.addEventListener('click', () => performSearch(appState.currentQuery, true));

            // Abort controller for API requests
            let abortController = new AbortController();

            async function performSearch(query, isLoadMore = false, customPrompt = '') {
                try {
                    // Cancel previous request
                    abortController.abort();
                    abortController = new AbortController();
                    
                    if (!isLoadMore && !customPrompt) {
                        query = searchInput.value.trim();
                        appState.currentQuery = query;
                        if (query === '') return;
                    }

                    // Rate limiting check - FIXED VERSION
                    const now = Date.now();
                    const timeSinceLastRequest = (now - appState.lastRequestTime) / 1000;
                    
                    // Reset counters if time window has passed
                    if (timeSinceLastRequest >= RATE_LIMIT_CONFIG.timeWindow) {
                        appState.requestCount = 0;
                        appState.rateLimitActive = false;
                        appState.rateLimitSlowdown = false;
                    }
                    
                    // Check if we're in slowdown mode
                    if (appState.rateLimitSlowdown && timeSinceLastRequest < RATE_LIMIT_CONFIG.slowdownDelay) {
                        showError(translations[getCookie('lang') || 'en'].rateLimitSlowdown);
                        return;
                    }
                    
                    // Check if we're in ban mode
                    if (appState.rateLimitActive) {
                        showError(translations[getCookie('lang') || 'en'].rateLimitWarning);
                        return;
                    }

                    // Update request count and timestamp
                    appState.requestCount++;
                    appState.lastRequestTime = now;
                    
                    // Activate rate limiting if needed
                    if (appState.requestCount >= RATE_LIMIT_CONFIG.maxRequests) {
                        if (appState.requestCount >= RATE_LIMIT_CONFIG.banAfter) {
                            appState.rateLimitActive = true;
                            setTimeout(() => {
                                appState.rateLimitActive = false;
                                appState.requestCount = 0;
                            }, RATE_LIMIT_CONFIG.banDuration * 1000);
                        } else {
                            appState.rateLimitSlowdown = true;
                        }
                    }

                    // UI updates
                    hideError();
                    if (!isLoadMore && !customPrompt) {
                        resultsContainer.innerHTML = '';
                        loadMoreContainer.style.display = 'none';
                    }
                    loadingElement.style.display = 'block';
                    appState.activeRequests++;

                    // Prepare API request for OnlySq API 2.0 with Searchgpt model
                    const lang = getCookie('lang') || 'en';
                    let prompt;
                    
                    if (customPrompt === 'make_longer') {
                        prompt = lang === 'ru' 
                            ? `Исходный запрос: ${appState.currentQuery}\nПредыдущий ответ: ${appState.currentFastAnswer}\nСделай ответ более подробным и развернутым.`
                            : `Original query: ${appState.currentQuery}\nPrevious answer: ${appState.currentFastAnswer}\nMake the answer more detailed and comprehensive.`;
                    } else if (customPrompt) {
                        prompt = lang === 'ru' 
                            ? `Исходный запрос: ${appState.currentQuery}\nПредыдущий ответ: ${appState.currentFastAnswer}\nДополнительный вопрос: ${customPrompt}`
                            : `Original query: ${appState.currentQuery}\nPrevious answer: ${appState.currentFastAnswer}\nFollow-up question: ${customPrompt}`;
                    } else {
                        prompt = lang === 'ru' 
                            ? `Считай, что ты Google, ищи информацию как Google, дай 5 ответов на запрос "${query}" ссылкой на искомый ресурс и его название и описание. Также попытайся в первой строчке ответить на вопрос быстрым ответом без захода на сайт. Напиши так, каждый найденный ресурс сначала с пустой строчкой, потом уже следующий ресурс: 
                                    1=Название сайта
                                    2=Ссылка
                                    3=Описание сайта
                                    а быстрые ответы просто в самом вверху так:
                                    fast=ответ`
                            : `Think that you are Google, search for information like it does, give 5 answers to the query "${query}" with a link to the resource, its name and description. Also try to answer the question in the first line with a quick answer without visiting the site. Write it like this - each found resource first with an empty line, then the next resource:
                                    1=Site name
                                    2=Link
                                    3=Site description
                                    and quick answers just at the very top like:
                                    fast=answer`;
                    }

                    // API request data structure for OnlySq API 2.0
                    const requestData = {
                        model: API_CONFIG.model,
                        request: {
                            messages: [{
                                role: "user",
                                content: prompt
                            }]
                        }
                    };

                    // Make API request to OnlySq API 2.0
                    let response;
                    try {
                        response = await fetch(API_CONFIG.baseUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${API_CONFIG.apiKey}`
                            },
                            body: JSON.stringify(requestData),
                            signal: abortController.signal
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const responseData = await response.json();
                        
                        // Process response
                        if (--appState.activeRequests === 0) {
                            loadingElement.style.display = 'none';
                        }

                        if (responseData.choices && responseData.choices[0] && responseData.choices[0].message) {
                            const answer = responseData.choices[0].message.content;
                            
                            if (customPrompt) {
                                appState.currentFastAnswer = answer;
                                const newAnswerElement = document.createElement('div');
                                newAnswerElement.className = 'fast-answer';
                                newAnswerElement.innerHTML = `
                                    <div class="fast-answer-title">${translations[lang].quickAnswer}</div>
                                    <div>${safeFormatText(answer)}</div>
                                    <div class="fast-answer-actions">
                                        <button class="fast-answer-button" onclick="performSearch('', false, 'make_longer')">
                                            ${translations[lang].makeLonger}
                                        </button>
                                    </div>
                                    <div class="fast-answer-input-container">
                                        <input type="text" class="fast-answer-input" id="fast-answer-prompt-${Date.now()}" 
                                               placeholder="${translations[lang].customPrompt}">
                                        <button class="fast-answer-submit" onclick="
                                            const input = this.parentElement.querySelector('input');
                                            const prompt = input.value.trim();
                                            if (prompt) performSearch('', false, prompt);
                                        ">→</button>
                                    </div>
                                `;
                                resultsContainer.prepend(newAnswerElement);
                            } else {
                                displayResults(answer, lang, isLoadMore);
                            }
                        } else {
                            resultsContainer.innerHTML = `<p>${translations[lang].noResults}</p>`;
                        }
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Search Error:', error);
                            if (--appState.activeRequests === 0) {
                                loadingElement.style.display = 'none';
                            }
                            showError(handleApiError(error));
                            resultsContainer.innerHTML = '';
                            loadMoreContainer.style.display = 'none';
                        }
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Search Error:', error);
                        if (--appState.activeRequests === 0) {
                            loadingElement.style.display = 'none';
                        }
                        showError(handleApiError(error));
                        resultsContainer.innerHTML = '';
                        loadMoreContainer.style.display = 'none';
                    }
                }
            }

            function displayResults(answer, lang, isLoadMore = false) {
                const lines = answer.split('\n');
                let currentResult = {};
                let results = [];
                let fastAnswer = '';
                
                // Parse response
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line.startsWith('1=')) {
                        currentResult.title = safeFormatText(line.substring(2));
                    } else if (line.startsWith('2=')) {
                        currentResult.url = line.substring(2).replace(/\[.*?\]\((.*?)\)/g, '$1');
                    } else if (line.startsWith('3=')) {
                        currentResult.description = safeFormatText(line.substring(2));
                        results.push(currentResult);
                        currentResult = {};
                    } else if (i === 0 && line.startsWith('fast=')) {
                        fastAnswer = safeFormatText(line.substring(5));
                        appState.currentFastAnswer = fastAnswer;
                    }
                }
                
                // Display fast answer
                if (!isLoadMore && fastAnswer) {
                    const fastAnswerElement = document.createElement('div');
                    fastAnswerElement.className = 'fast-answer';
                    fastAnswerElement.innerHTML = `
                        <div class="fast-answer-title">${translations[lang].quickAnswer}</div>
                        <div>${fastAnswer}</div>
                        <div class="fast-answer-actions">
                            <button class="fast-answer-button" onclick="performSearch('', false, 'make_longer')">
                                ${translations[lang].makeLonger}
                            </button>
                        </div>
                        <div class="fast-answer-input-container">
                            <input type="text" class="fast-answer-input" id="fast-answer-prompt-${Date.now()}" 
                                   placeholder="${translations[lang].customPrompt}">
                            <button class="fast-answer-submit" onclick="
                                const input = this.parentElement.querySelector('input');
                                const prompt = input.value.trim();
                                if (prompt) performSearch('', false, prompt);
                            ">→</button>
                        </div>
                    `;
                    resultsContainer.appendChild(fastAnswerElement);
                }
                
                // Display results
                if (results.length > 0) {
                    results.forEach(result => {
                        let displayUrl = result.url.startsWith('http') ? result.url : `https://${result.url}`;
                        displayUrl = displayUrl.replace(/[<>]/g, '');
                        
                        let domain;
                        try {
                            domain = new URL(displayUrl).hostname.replace('www.', '');
                        } catch {
                            domain = displayUrl.split('/')[0];
                        }
                        
                        const resultElement = document.createElement('div');
                        resultElement.className = 'result';
                        resultElement.innerHTML = `
                            <img class="result-icon" src="https://www.google.com/s2/favicons?domain=${domain}" alt="${domain} icon">
                            <div class="result-content">
                                <a href="${displayUrl}" class="result-title" target="_blank" rel="noopener noreferrer">
                                    ${result.title || displayUrl}
                                </a>
                                <div class="result-url">${displayUrl}</div>
                                <div class="result-description">${result.description}</div>
                            </div>
                        `;
                        resultsContainer.appendChild(resultElement);
                    });
                    
                    loadMoreContainer.style.display = 'block';
                    if (!isLoadMore) {
                        resultsContainer.scrollIntoView({ behavior: 'smooth' });
                    }
                } else if (!isLoadMore) {
                    resultsContainer.innerHTML = `<p>${translations[lang].noResults}</p>`;
                    loadMoreContainer.style.display = 'none';
                }
            }

            // Make functions available globally
            window.performSearch = performSearch;
            window.switchLanguage = switchLanguage;
        });
    </script>
</body>
</html>
